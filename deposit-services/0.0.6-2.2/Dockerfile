FROM openjdk:8u151-jre-alpine3.7

ARG SPRING_ACTIVEMQ_BROKER_URL
ARG PASS_FEDORA_BASEURL
ARG PASS_FEDORA_USER
ARG PASS_FEDORA_PASSWORD
ARG PASS_ELASTICSEARCH_URL
ARG PASS_ELASTICSEARCH_LIMIT
ARG PASS_DEPOSIT_TRANSPORT_CONFIGURATION
ARG FCREPO_HOST
ARG FCREPO_PORT
ARG FCREPO_JMS_PORT
ARG DSPACE_HOST
ARG DSPACE_PORT
ARG FTP_HOST
ARG FTP_PORT
ARG ES_HOST
ARG ES_PORT
ARG DEPOSIT_DEBUG_PORT

ENV DEPOSIT_SERVICES_VERSION=0.0.6 \
    JSONLD_CONTEXT_VERSION=2.2 \
    FCREPO_HOST=${FCREPO_HOST:-fcrepo} \
    FCREPO_PORT=${FCREPO_PORT:-8080} \
    FCREPO_JMS_PORT=${FCREPO_JMS_PORT:-61616} \
    DSPACE_HOST=${DSPACE_HOST:-dspace} \
    DSPACE_PORT=${DSPACE_PORT:-8181} \
    FTP_HOST=${FTP_HOST:-ftpserver} \
    FTP_PORT=${FTP_PORT:-21} \
    ES_HOST=${ES_HOST:-elasticsearch} \
    ES_PORT=${ES_PORT:-9200} \
    DEPOSIT_DEBUG_PORT=${DEPOSIT_DEBUG_PORT:-5007} \
    PASS_FEDORA_USER=${PASS_FEDORA_USER:-fedoraAdmin} \
    PASS_FEDORA_PASSWORD=${PASS_FEDORA_PASSWORD:-moo} \
    PASS_ELASTICSEARCH_LIMIT=${PASS_ELASTICSEARCH_LIMIT:-100} \
    PASS_DEPOSIT_TRANSPORT_CONFIGURATION=${PASS_DEPOSIT_TRANSPORT_CONFIGURATION:-classpath:/packagers.properties}

ENV JAVA_TOOL_OPTIONS -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=${DEPOSIT_DEBUG_PORT}

EXPOSE ${DEPOSIT_DEBUG_PORT}
# TODOs
# - Logging configuration

#java -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap
# spring.activemq.broker-url

#RUN apk update && \
#    apk add --no-cache ca-certificates wget && \
#    wget -O deposit-messaging.jar \
#        https://github.com/OA-PASS/nihms-submission/releases/download/deposit-services-${DEPOSIT_SERVICES_VERSION}/deposit-messaging-${DEPOSIT_SERVICES_VERSION}-${JSONLD_CONTEXT_VERSION}.jar

ADD deposit-messaging-${DEPOSIT_SERVICES_VERSION}-${JSONLD_CONTEXT_VERSION}.jar deposit-messaging.jar

ENTRYPOINT [ "java", "-XX:+UnlockExperimentalVMOptions", "-XX:+UseCGroupMemoryLimitForHeap", "-jar", "deposit-messaging.jar" ]
CMD [ "listen" ]
